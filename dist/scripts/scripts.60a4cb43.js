"use strict";angular.module("anotareApp",["ngAnimate","ngCookies","ngResource","ngSanitize","ngTouch","ui.router"]).config(["$stateProvider","$urlRouterProvider",function(a,b){b.otherwise("/"),a.state("welcome",{url:"/",templateUrl:"views/welcome.html",controller:"GalleryCtrl"}).state("signup",{url:"/signup",templateUrl:"views/signup.html",controller:"GalleryCtrl"}).state("root",{url:"/main",templateUrl:"views/root.html",controller:"AnnotationCtrl"}).state("root.explore",{url:"/explore",templateUrl:"views/explore.html",controller:"GalleryCtrl"}).state("root.annotation",{url:"/annotation",templateUrl:"views/annotation.html"})}]),angular.module("anotareApp").controller("AnnotationCtrl",["$scope","$http","AlbumService",function(a,b,c){a.imageScope,a.editMode=!1,a.annotationText="",a.comments,a.toolIcons=[{url:"images/tool-line.png",name:"line-tool"},{url:"images/tool-square.png",name:"square-tool"},{url:"images/tool-circle.png",name:"circle-tool"},{url:"images/tool-trig.png",name:"trig-tool"}],a.getImage=function(){c.getImage().then(function(b){a.imageScope=b.data.Album},function(a){console.log("Failed to get the image, result is "+a.toString())})}}]),angular.module("anotareApp").controller("GalleryCtrl",["$scope","$http","AlbumService",function(a,b,c){a.items=[],a.imageScope=[],a.getImage=function(){c.getImage().then(function(b){a.imageScope=b.data.Album},function(a){console.log("Failed to get the image, result is "+a.toString())})}}]),angular.module("anotareApp").directive("displayAnnotation",function(){return{restrict:"E",replace:!0,templateUrl:"views/display-annotation.html",link:function(a,b,c,d){a.editMode=!1,a.viewMode=!1,a.showAnnotation=!1,a.showDropdown=!0,window.oncontextmenu=function(){return!1};var e,f,g,h={strokeColor:new paper.Color(.8,.9),strokeWidth:1.5,fillColor:new paper.Color(0,0,0,.2)},i={strokeWidth:0,fillColor:null},j=({strokeColor:new paper.Color(1,1,0,1),strokeWidth:1.5,fillColor:new paper.Color(1,1,0,1)},{strokeColor:new paper.Color(.8,.9),strokeWidth:1.5,fillColor:new paper.Color(.8,.9)}),k={strokeColor:new paper.Color(.7,.1,.1,1),strokeWidth:2,fillColor:new paper.Color(0,0,0,0)},l={strokeColor:new paper.Color(.9,.1,.1,1),strokeWidth:3,fillColor:new paper.Color(0,0,0,.1)},m=({strokeColor:new paper.Color(0,0,1,1),strokeWidth:1},{fillColor:new paper.Color(.2,.2,.8,1),strokeColor:new paper.Color(1,1,1,1),strokeWidth:.3},function(){e=document.getElementById("main-canvas"),e.setAttribute("width",.55*screen.availWidth),e.setAttribute("height",.75*screen.availHeight),paper.setup(e),a.paper=paper,a.getImage()});a.switchEditMode=function(){a.viewMode&&a.switchViewMode(),a.editMode=!a.editMode,a.editMode&&(a.showDropdown=!0,a.hideDropdown()),"undefined"!=typeof g&&(a.editMode?p(g,"makeNew"):(g.removeSegments(),g.frame.remove()))},a.switchViewMode=function(){a.editMode&&a.switchEditMode(),a.viewMode=!a.viewMode;for(var b=paper.project.getActiveLayer().children,c=1;c<b.length;c++)a.viewMode?b[c].style=i:b[c].style=h;a.viewMode&&a.$apply(function(){a.showAnnotation=!1})};var n=function(b){var c=function(){var a=this.getHeight(),b=this.getWidth(),c=Math.max(a/e.height,b/e.width);1>=c?(this.setHeight(a*c),this.setWidth(b*c)):(this.setHeight(a/c),this.setWidth(b/c))},d=new paper.Raster(b.src);d.type="main-image",d.onLoad=c,d.position=paper.view.center,d.onClick=function(b){a.$apply(function(){a.showAnnotation=!1}),"undefined"!=typeof g&&(g.style=h,g.active=!1,g.frame&&(g.removeSegments(),g.frame.remove())),a.editMode&&(a.showDropdown?(a.drawDropdown(b),a.showDropdown=!1):(a.hideDropdown(),a.showDropdown=!0))}},o=function(a,b,c){var d=function(a,b){return(a.x-b.x)*(a.x-b.x)+(a.y-b.y)*(a.y-b.y)},e=d(a,b),f=d(a,c),g=d(b,c),h=180*Math.acos((e+f-g)/(2*Math.sqrt(e)*Math.sqrt(f)))/Math.PI;return h},p=function(a,b){var c=function(a){var b=a.bounds.clone().expand(5,5);a.frame=new paper.Path.Rectangle(b),a.frame.strokeWidth=1,a.frame.strokeColor="blue",a.frame.insert(2,new paper.Point(b.center.x,b.top)),a.frame.insert(2,new paper.Point(b.center.x,b.top-15)),a.frame.insert(2,new paper.Point(b.center.x,b.top))},d=function(a){a.frame.bottomLeftSegment=new paper.Path.Rectangle({x:a.frame.segments[0].point.x-2.5,y:a.frame.segments[0].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){a.bounds.setBottomLeft(b.point),p(a,"updateAll")}}),a.frame.topLeftSegment=new paper.Path.Rectangle({x:a.frame.segments[1].point.x-2.5,y:a.frame.segments[1].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){a.bounds.setTopLeft(b.point),p(a,"updateAll")}}),a.frame.topRightSegment=new paper.Path.Rectangle({x:a.frame.segments[5].point.x-2.5,y:a.frame.segments[5].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){a.bounds.setTopRight(b.point),p(a,"updateAll")}}),a.frame.bottomRightSegment=new paper.Path.Rectangle({x:a.frame.segments[6].point.x-2.5,y:a.frame.segments[6].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){a.bounds.setBottomRight(b.point),p(a,"updateAll")}}),a.frame.rotateSegment=new paper.Path.Rectangle({x:a.frame.segments[3].point.x-2.5,y:a.frame.segments[3].point.y-2.5,width:5,height:5,fillColor:"white",strokeColor:"blue",strokeWidth:1,onMouseDrag:function(b){var c=o(a.bounds.center,a.frame.segments[3].point,b.point);a.rotate(c),a.frame.rotate(c),p(a,"updateSegments"),a.frame.bottomRightSegment.rotate(c),a.frame.bottomLeftSegment.rotate(c),a.frame.topRightSegment.rotate(c),a.frame.topLeftSegment.rotate(c),a.frame.rotateSegment.rotate(c)}})},e=function(){a.frame.bottomLeftSegment.remove(),a.frame.bottomRightSegment.remove(),a.frame.topLeftSegment.remove(),a.frame.topRightSegment.remove(),a.frame.rotateSegment.remove()};a.removeSegments=e,"makeNew"===b?(c(a),d(a)):a.frame&&"updateAll"===b?(e(a),a.frame.remove(),c(a),d(a)):a.frame&&"updateSegments"===b&&(e(a),d(a))};a.drawAnnotation=function(b){var c,d=function(b){var c=function(a){$("html,body").css("cursor","pointer"),a.active||(a.style=k)},d=function(a){$("html,body").css("cursor","default"),a.active||("pin"===a.type?a.style=j:a.style=h)},f=function(b,c){var d=function(a,b){var c=b.bounds.height/2,d=b.bounds.width/2;return a.x<b.bounds||a.x>e.width-d||a.y<c||a.y>e.height-c?!1:!0};a.editMode&&d(b.point,c)&&(c.position=b.point,p(c,"updateAll"))},i=function(b,c){"undefined"!=typeof g&&g!==c&&("pin"===g.type?g.style=j:g.style=h,g.active=!1,a.editMode&&(g.removeSegments(),g.frame.remove())),g=c,c.active=!0,c.style=l,a.hideDropdown(),a.showDropdown=!1,a.showAnnotation=!0,a.$apply(function(){a.annotationText=c.text,a.comments=c.comments}),a.editMode&&(3===b.event.which&&a.drawDropdown(b,c),c.frame?p(c,"updateAll"):p(c,"makeNew"))};b.onMouseDrag=function(a){f(a,b)},b.onMouseEnter=function(){c(b)},b.onMouseLeave=function(){d(b)},b.onClick=function(a){return i(a,b),!1}},f=function(a){var b;return b=new paper.Path.Circle("undefined"==typeof a.radius?{radius:50,style:h}:{radius:a.radius,style:h})},i=function(a){var b;return b=new paper.Path.Rectangle("undefined"==typeof a.width||"undefined"==typeof a.height?{width:70,height:70,style:h}:{width:a.width,height:a.height,style:h})},m=function(a){var b;return b=new paper.Path.Ellipse("undefined"==typeof a.width||"undefined"==typeof a.height?{width:70,height:50,style:h}:{width:a.width,height:a.height,style:h})},n=function(a){var b=new paper.Path.Circle({radius:3,style:j});return b};return"circle"===b.type?c=f(b):"rectangle"===b.type?c=i(b):"ellipse"===b.type?c=m(b):"pin"===b.type&&(c=n(b)),"undefined"!=typeof c?(c.type=b.type,c.position.setX(b.x),c.position.setY(b.y),c.text=b.text,c.comments=b.comments,c.active=!1,d(c),c):void console.log("Shape"+b.type+"is unidentified")};var q=function(b){"undefined"!=typeof b&&(n(b),b.annotations.forEach(function(b){a.drawAnnotation(b)}))};a.$watch("imageScope",function(a,b){"undefined"==typeof a||a.length<=0?f=b:(f=a,q(f[0]))}),m()}}}),angular.module("anotareApp").directive("dropTool",function(){return{restrict:"E",replace:!0,templateUrl:"views/dropdown.html",link:function(a,b,c,d){var e,f,g,h,i=$("#dropdown-context"),j=!1;a.drawDropdown=function(b,c){i.css({top:b.event.y+"px",left:b.event.x+"px",display:"block",zIndex:1001}),"undefined"==typeof c?(h=!0,e={type:"pin",x:b.point.x,y:b.point.y,text:""},f=a.drawAnnotation(e),a.$apply(function(){a.annotationText=f.text})):(h=!1,f=c,g=c,a.newText=c.text,console.log(c.type))},a.hideDropdown=function(){i.css({display:"none"}),!j&&h&&"undefined"!=typeof f?f.remove():(j=!1,f=void 0)},a.submitNewAnnotation=function(){""!==a.newText.trim()?(j=!0,f.text=a.newText,a.hideDropdown(),a.showDropdown=!0):console.log("you have to write on the input field to submit a new annotation")},a.cancelNewAnnotation=function(){a.hideDropdown(),a.showDropdown=!0},a.dropdownClick=function(b){var c=f.position.x,d=f.position.y;f.remove();var i;i=h?"":g.text,"circle-tool"===a.toolIcons[b].name?e={type:"circle",x:c,y:d,text:i}:"square-tool"===a.toolIcons[b].name&&(e={type:"rectangle",x:c,y:d,text:i}),f=a.drawAnnotation(e)}}}}),angular.module("anotareApp").directive("photoSlider",["$interval",function(a){return{restrict:"EA",link:function(b){b.currentIndex=0,b.loadToItem=function(){for(var a=1;5>a;a++)b.items.push(b.imageScope[a]),b.items[a-1].visible=!1;b.items[b.currentIndex].visible=!0},b.next=function(){b.items[b.currentIndex].visible=!1,b.currentIndex=b.currentIndex<b.items.length-1?b.currentIndex+1:0,b.items[b.currentIndex].visible=!0},b.prev=function(){b.items[b.currentIndex].visible=!1,b.currentIndex=b.currentIndex>0?b.currentIndex-1:b.items.length-1,b.items[b.currentIndex].visible=!0},b.setCurrentIndex=function(a){b.currentIndex=a},b.isCurrentIndex=function(a){return b.currentIndex===a},b.updateSlide=function(){"undefined"!=typeof b.items&&b.items.length>0&&(angular.forEach(b.items,function(a){a.visible=!1}),b.items[b.currentIndex].visible=!0)},b.$watch("currentIndex",function(){b.updateSlide()}),b.$watch("imageScope",function(a,c){"undefined"!=typeof a&&a.length>0&&b.loadToItem()}),b.getImage(),a(b.next,5e3)}}}]),angular.module("anotareApp").directive("parallax",function(){return{restrict:"A",replace:!0,scope:{offset:"@offsetParallax",direction:"@directionParallax"},link:function(a,b,c,d){var e={x:-1,y:-1},f=Number(b.css("margin-top").replace(/[^-\d\.]/g,"")),g=Number(b.css("margin-left").replace(/[^-\d\.]/g,"")),h=Number(b[0].style.width.replace(/[^-\d\.]/g,"")),i=Number(b[0].style.height.replace(/[^-\d\.]/g,"")),j=$(window).height()-i/2+10,k=$(window).width()-h/2;$(document).mousemove(function(c){if(e.x=c.pageX,e.y=c.pageY,"reverse"===a.direction)var d=f-(e.y-j)/j*a.offset,h=g-(e.x-k)/k*a.offset;else var d=f+(e.y-j)/j*a.offset,h=g+(e.x-k)/k*a.offset;b.css({"margin-top":d+"px","margin-left":h+"px"})})}}}),angular.module("anotareApp").directive("horizontalInfinityScroll",function(){return{restrict:"EA",link:function(a,b,c){var d,e=0,f=!0,g=b[0],h=!1;a.loadMore=function(){for(var b=0;5>b&&e<a.imageScope.length;b++)a.items.push(a.imageScope[e]),e++},a.scrollRight=function(){h=!0,d=window.setInterval(function(){h&&$(g).animate({scrollLeft:"+=20"},100)},100)},a.scrollEnd=function(){window.clearInterval(d),h=!1},a.scrollLeft=function(){h=!0,d=window.setInterval(function(){h&&$(g).animate({scrollLeft:"-=20"},100)},100)},a.getImage(),a.$watch("imageScope",function(b,c){"undefined"!=typeof b&&b.length>0&&f&&(f=!1,a.loadMore())}),b.bind("scroll",function(){g.scrollLeft+g.offsetWidth>=g.scrollWidth&&a.$apply(c.horizontalInfinityScroll)})}}}),angular.module("anotareApp").factory("AlbumService",["$http",function(a){var b={getImage:function(){return a.get("data/album.json").success(function(a){return a.Album}).error(function(a,b){console.log("Oh no! An error! Error status: "+b)})}};return b}]);